{% extends "base.html" %}

{% block title %}Preprocessing{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forecast Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 15px;
            background-color: #212529; /* Dark background for the body */
            color: #ffffff; /* Light text color */
        }
    
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #2c2c2c; /* Darker background for the table */
        }
    
        th, td {
            border: 1px solid #444; /* Darker border color */
            padding: 10px;
            text-align: center;
            color: #ffffff; /* Light text color */
        }
    
        th {
            background-color: #333; /* Dark gray for table header */
        }
    
        .header-row th {
            background-color: #444; /* Slightly lighter dark gray */
            font-weight: bold;
        }
    
        .table-header-row th {
            background-color: #555; /* Medium gray */
            font-weight: bold;
        }
    
        .section-header-row th {
            background-color: #666; /* Lighter gray */
            font-weight: bold;
        }
    
        .sum-row {
            background-color: #3c763d; /* Dark green for sum row */
            font-weight: bold;
            color: #ffffff; /* White text color */
        }
    
        .buttons-container {
            margin-top: 20px;
            text-align: center;
        }
    
        .buttons-container button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            border: none; /* Remove border for a cleaner look */
            background-color: #007bff; /* Bootstrap primary color */
            color: #ffffff; /* Light text color */
            transition: background-color 0.3s ease; /* Smooth transition for hover */
        }
    
        .buttons-container button:hover {
            background-color: #0056b3; /* Darker shade on hover */
        }
    
        .remove-button {
            background-color: transparent;
            border: none;
            color: #dc3545; /* Bootstrap danger color */
            cursor: pointer;
            font-size: 16px;
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
        }
    
        .remove-button:hover {
            color: #c82333; /* Darker red on hover */
        }
    
        .no-border {
            border: none !important;
        }
    
        .highlighted {
            background-color: #28af1c; /* Darker highlighted background */
            color: #ffffff; /* White text color */
        }
    
        .selectable {
            cursor: pointer;
        }
    
        .manually-changed {
            background-color: #d42020; /* Subtle yellow, keep it for manual changes */
            transition: background-color 0.5s ease; /* Smooth transition */
        }
    </style>
</head>
<body>

    <h2 style="text-align: center;">12 Month Forecast</h2>
    

    <table id="forecast-table">
        <tr class="section-header-row">
            <th>Month</th>
            <th>{{month_headers[0]}}</th>
            <th>{{month_headers[1]}}</th>
            <th>{{month_headers[2]}}</th>
            <th>{{month_headers[3]}}</th>
            <th>{{month_headers[4]}}</th>            
            <th>{{month_headers[5]}}</th>
            <th>{{month_headers[6]}}</th>
            <th>{{month_headers[7]}}</th>
            <th>{{month_headers[8]}}</th>
            <th>{{month_headers[9]}}</th>
            <th>{{month_headers[10]}}</th>
            <th>{{month_headers[11]}}</th>
            <th>{{month_headers[12]}}</th>
            <th>{{month_headers[13]}}</th>
            <th>{{month_headers[14]}}</th>
            <th>{{month_headers[15]}}</th>
        </tr>


        <tr class="section-header-row">
            <th colspan="17">Time & Material Forecast</th>
        </tr>
        
        <!-- Finland multiplicative -->
        <tr class="header-row">
            <td></td>
            <th colspan="16">Finland</th>
        </tr>
        <tr>            
            <td>Multiplicative</td>
            <td> </td>            
            <td> </td>
            <td> </td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="1" id="fin-m-1">{{forecast_fin_mp[0]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="2" id="fin-m-2">{{forecast_fin_mp[1]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="3" id="fin-m-3">{{forecast_fin_mp[2]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="4" id="fin-m-4">{{forecast_fin_mp[3]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="5" id="fin-m-5">{{forecast_fin_mp[4]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="6" id="fin-m-6">{{forecast_fin_mp[5]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="7" id="fin-m-7">{{forecast_fin_mp[6]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="8" id="fin-m-8">{{forecast_fin_mp[7]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="9" id="fin-m-9">{{forecast_fin_mp[8]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="10" id="fin-m-10">{{forecast_fin_mp[9]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="11" id="fin-m-11">{{forecast_fin_mp[10]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="12" id="fin-m-12">{{forecast_fin_mp[11]}}</td>
            <td class="highlighted" data-loc="fin" data-fc="m" data-month="13" id="fin-m-13">{{forecast_fin_mp[12]}}</td>
        </tr>

        <!-- Finland runrate -->
        <tr>
            <td>Run rate</td>
            <td> </td>            
            <td> </td>
            <td> </td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="1" id="fin-r-1">{{forecast_fin_rr[0]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="2" id="fin-r-2">{{forecast_fin_rr[1]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="3" id="fin-r-3">{{forecast_fin_rr[2]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="4" id="fin-r-4">{{forecast_fin_rr[3]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="5" id="fin-r-5">{{forecast_fin_rr[4]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="6" id="fin-r-6">{{forecast_fin_rr[5]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="7" id="fin-r-7">{{forecast_fin_rr[6]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="8" id="fin-r-8">{{forecast_fin_rr[7]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="9" id="fin-r-9">{{forecast_fin_rr[8]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="10" id="fin-r-10">{{forecast_fin_rr[9]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="11" id="fin-r-11">{{forecast_fin_rr[10]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="12" id="fin-r-12">{{forecast_fin_rr[11]}}</td>
            <td class="selectable" data-loc="fin" data-fc="r" data-month="13" id="fin-r-13">{{forecast_fin_rr[12]}}</td>
        </tr>

        <tr>
            <td>Actuals</td>
            <td>{{actual_fin[0]}}</td>
            <td>{{actual_fin[1]}}</td>
            <td>{{actual_fin[2]}}</td>            

            <td colspan=13>&nbsp;</td>
        </tr>

        <tr class="header-row">
            <td></td>
            <th colspan="16">India</th>
        </tr>

        <!-- India multiplicative -->
        <tr>
            <td>Multiplicative</td>
            <td> </td>            
            <td> </td>
            <td> </td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="1" id="ind-m-1">{{forecast_ind_mp[0]}}</td>            
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="2" id="ind-m-2">{{forecast_ind_mp[1]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="3" id="ind-m-3">{{forecast_ind_mp[2]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="4" id="ind-m-4">{{forecast_ind_mp[3]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="5" id="ind-m-5">{{forecast_ind_mp[4]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="6" id="ind-m-6">{{forecast_ind_mp[5]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="7" id="ind-m-7">{{forecast_ind_mp[6]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="8" id="ind-m-8">{{forecast_ind_mp[7]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="9" id="ind-m-9">{{forecast_ind_mp[8]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="10" id="ind-m-10">{{forecast_ind_mp[9]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="11" id="ind-m-11">{{forecast_ind_mp[10]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="12" id="ind-m-12">{{forecast_ind_mp[11]}}</td>
            <td class="highlighted" data-loc="ind" data-fc="m" data-month="13" id="ind-m-13">{{forecast_ind_mp[12]}}</td>
        </tr>

        <!-- India Runrate -->
        <tr>
            <td>Run rate</td>            
            <td> </td>            
            <td> </td>
            <td> </td>                     
            <td class="selectable" data-loc="ind" data-fc="r" data-month="1" id="ind-r-1">{{forecast_ind_rr[0]}}</td>            
            <td class="selectable" data-loc="ind" data-fc="r" data-month="2" id="ind-r-2">{{forecast_ind_rr[1]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="3" id="ind-r-3">{{forecast_ind_rr[2]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="4" id="ind-r-4">{{forecast_ind_rr[3]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="5" id="ind-r-5">{{forecast_ind_rr[4]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="6" id="ind-r-6">{{forecast_ind_rr[5]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="7" id="ind-r-7">{{forecast_ind_rr[6]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="8" id="ind-r-8">{{forecast_ind_rr[7]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="9" id="ind-r-9">{{forecast_ind_rr[8]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="10" id="ind-r-10">{{forecast_ind_rr[9]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="11" id="ind-r-11">{{forecast_ind_rr[10]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="12" id="ind-r-12">{{forecast_ind_rr[11]}}</td>
            <td class="selectable" data-loc="ind" data-fc="r" data-month="13" id="ind-r-13">{{forecast_ind_rr[12]}}</td>            
        </tr>        

        <tr>
            <td>Actuals</td>
            <td>{{actual_ind[0]}}</td>
            <td>{{actual_ind[1]}}</td>
            <td>{{actual_ind[2]}}</td>           
            <td colspan=13>&nbsp;</td>
        </tr>   

        <tr class="header-row">
            <td></td>
            <th colspan="16">NS</th>
        </tr>  

        <!-- Nearshore multiplicative -->
        <tr>
            <td>Multiplicative</td>
            <td> </td>            
            <td> </td>
            <td> </td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="1" id="ns-m-1">{{forecast_ns_mp[0]}}</td>            
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="2" id="ns-m-2">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="3" id="ns-m-3">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="4" id="ns-m-4">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="5" id="ns-m-5">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="6" id="ns-m-6">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="7" id="ns-m-7">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="8" id="ns-m-8">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="9" id="ns-m-9">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="10" id="ns-m-10">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="11" id="ns-m-11">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="12" id="ns-m-12">{{forecast_ns_mp[0]}}</td>
            <td class="highlighted" data-loc="ns" data-fc="m" data-month="13" id="ns-m-13">{{forecast_ns_mp[0]}}</td>               
        </tr>

        <!-- Nearshore runrate -->
        <tr>
            <td>Run rate</td>
            <td> </td>            
            <td> </td>
            <td> </td>  
            <td class="selectable" data-loc="ns" data-fc="r" data-month="1" id="ns-r-1">{{forecast_ns_mp[0]}}</td>            
            <td class="selectable" data-loc="ns" data-fc="r" data-month="2" id="ns-r-2">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="3" id="ns-r-3">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="4" id="ns-r-4">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="5" id="ns-r-5">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="6" id="ns-r-6">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="7" id="ns-r-7">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="8" id="ns-r-8">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="9" id="ns-r-9">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="10" id="ns-r-10">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="11" id="ns-r-11">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="12" id="ns-r-12">{{forecast_ns_mp[0]}}</td>
            <td class="selectable" data-loc="ns" data-fc="r" data-month="13" id="ns-r-13">{{forecast_ns_mp[0]}}</td>              
        </tr>       
        
        <tr>
            <td>Actuals</td>
            <td>{{actual_ns[0]}}</td>
            <td>{{actual_ns[0]}}</td>
            <td>{{actual_ns[0]}}</td>       
            <td colspan=13>&nbsp;</td>
        </tr>         

        <tr class="header-row">
            <td></td>
            <th colspan="16">T&M Forecast Adjustments</th>
        </tr>
        <tr>
            <td>Raise FIN %</td>
            <td colspan="3" class="no-border"></td>
            <td id="r-fin-1">0.0</td>            
            <td id="r-fin-2">0.0</td>
            <td id="r-fin-3">0.0</td>
            <td id="r-fin-4">0.0</td>
            <td id="r-fin-5">0.0</td>
            <td id="r-fin-6">0.0</td>
            <td id="r-fin-7">0.0</td>
            <td id="r-fin-8">0.0</td>
            <td id="r-fin-9">0.0</td>
            <td id="r-fin-10">0.0</td>
            <td id="r-fin-11">0.0</td>
            <td id="r-fin-12">0.0</td>
            <td id="r-fin-13">0.0</td>
        </tr>         
        <tr>
            <td>Raise IND %</td>
            <td colspan="3" class="no-border"></td>
            <td id="r-ind-1">0.0</td>            
            <td id="r-ind-2">0.0</td>
            <td id="r-ind-3">0.0</td>
            <td id="r-ind-4">0.0</td>
            <td id="r-ind-5">0.0</td>
            <td id="r-ind-6">0.0</td>
            <td id="r-ind-7">0.0</td>
            <td id="r-ind-8">0.0</td>
            <td id="r-ind-9">0.0</td>
            <td id="r-ind-10">0.0</td>
            <td id="r-ind-11">0.0</td>
            <td id="r-ind-12">0.0</td>
            <td id="r-ind-13">0.0</td>
        </tr>         
        <tr>
            <td>Raise NS %</td>
            <td colspan="3" class="no-border"></td>
            <td id="r-ns-1">0.0</td>            
            <td id="r-ns-2">0.0</td>
            <td id="r-ns-3">0.0</td>
            <td id="r-ns-4">0.0</td>
            <td id="r-ns-5">0.0</td>
            <td id="r-ns-6">0.0</td>
            <td id="r-ns-7">0.0</td>
            <td id="r-ns-8">0.0</td>
            <td id="r-ns-9">0.0</td>
            <td id="r-ns-10">0.0</td>
            <td id="r-ns-11">0.0</td>
            <td id="r-ns-12">0.0</td>
            <td id="r-ns-13">0.0</td>
        </tr>   
        <tr>
            <td>FIN unusual sick leaves %</td>
            <td colspan="3" class="no-border"></td>
            <td id="sl-1">0.0</td>            
            <td id="sl-2">0.0</td>
            <td id="sl-3">0.0</td>
            <td id="sl-4">0.0</td>
            <td id="sl-5">0.0</td>
            <td id="sl-6">0.0</td>
            <td id="sl-7">0.0</td>
            <td id="sl-8">0.0</td>
            <td id="sl-9">0.0</td>
            <td id="sl-10">0.0</td>
            <td id="sl-11">0.0</td>
            <td id="sl-12">0.0</td>
            <td id="sl-13">0.0</td>
        </tr>          

        <tr class="section-header-row">
            <th colspan="17">Total Forecast</th>
        </tr>
        
        <tr>
            <td>Time & Material Total</td>
            <td colspan="3" class="no-border"></td>
            <td id="ttm-1"></td>            
            <td id="ttm-2"></td>
            <td id="ttm-3"></td>
            <td id="ttm-4"></td>
            <td id="ttm-5"></td>
            <td id="ttm-6"></td>
            <td id="ttm-7"></td>
            <td id="ttm-8"></td>
            <td id="ttm-9"></td>
            <td id="ttm-10"></td>
            <td id="ttm-11"></td>
            <td id="ttm-12"></td>
            <td id="ttm-13"></td>
        </tr>
        
        <tr>
            <td>Fixed Fee</td>
            <td colspan="3" class="no-border"></td>   
            <td id="ff-1">0</td>            
            <td id="ff-2">0</td>
            <td id="ff-3">0</td>
            <td id="ff-4">0</td>
            <td id="ff-5">0</td>
            <td id="ff-6">0</td>
            <td id="ff-7">0</td>
            <td id="ff-8">0</td>
            <td id="ff-9">0</td>
            <td id="ff-10">0</td>
            <td id="ff-11">0</td>
            <td id="ff-12">0</td>
            <td id="ff-13">0</td>
        </tr>         
        
        <tr>
            <td>Sanctions</td>
            <td colspan="3" class="no-border"></td>
            <td id="ss-1">0</td>            
            <td id="ss-2">0</td>
            <td id="ss-3">0</td>
            <td id="ss-4">0</td>
            <td id="ss-5">0</td>
            <td id="ss-6">0</td>
            <td id="ss-7">0</td>
            <td id="ss-8">0</td>
            <td id="ss-9">0</td>
            <td id="ss-10">0</td>
            <td id="ss-11">0</td>
            <td id="ss-12">0</td>
            <td id="ss-13">0</td>
        </tr> 
        
        <tr>
            <td>Personnel changes</td>
            <td colspan="3" class="no-border"></td>
            <td id="pc-1">0</td>            
            <td id="pc-2">0</td>
            <td id="pc-3">0</td>
            <td id="pc-4">0</td>
            <td id="pc-5">0</td>
            <td id="pc-6">0</td>
            <td id="pc-7">0</td>
            <td id="pc-8">0</td>
            <td id="pc-9">0</td>
            <td id="pc-10">0</td>
            <td id="pc-11">0</td>
            <td id="pc-12">0</td>
            <td id="pc-13">0</td>
        </tr>        
        
        <tr>
            <td>Travel costs</td>
            <td colspan="3" class="no-border"></td>
            <td id="tc-1">0</td>            
            <td id="tc-2">0</td>   
            <td id="tc-3">0</td>   
            <td id="tc-4">0</td>   
            <td id="tc-5">0</td>   
            <td id="tc-6">0</td>   
            <td id="tc-7">0</td>   
            <td id="tc-8">0</td>   
            <td id="tc-9">0</td>   
            <td id="tc-10">0</td>   
            <td id="tc-11">0</td>   
            <td id="tc-12">0</td>   
            <td id="tc-13">0</td>   
        </tr>       
        
        <tr class="sum-row" id="total-row">
            <td>TOTAL FORECAST</td>
            <td colspan="3" class="no-border"></td>          
            <td id="total-1"></td>   
            <td id="total-2"></td>   
            <td id="total-3"></td>   
            <td id="total-4"></td>   
            <td id="total-5"></td>   
            <td id="total-6"></td>   
            <td id="total-7"></td>   
            <td id="total-8"></td>   
            <td id="total-9"></td>   
            <td id="total-10"></td>   
            <td id="total-11"></td>   
            <td id="total-12"></td>   
            <td id="total-13"></td>               
        </tr>                                         
    </table>

    
    <!-- Buttons for actions -->
    <div class="buttons-container">
        <button onclick="calculateTotals()">Calculate Totals</button>
        <button onclick="addRevenueRow2()">Add Revenue Row</button>
        <button onclick="exportToCSV()">Export to CSV (Excel)</button>
        <button onclick="saveChanges()">Save Changes</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/load_saved_values')
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        console.error("No saved values found:", data.message);
                        return;
                    }

                    // Get the current month and adjust for 13 months
                    const now = new Date();
                    const currentMonth = now.getMonth(); // 0 = Jan, 1 = Feb, etc.
                    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

                    // Generate the 13-month sequence
                    const monthSequence = [];
                    for (let i = 0; i < 13; i++) {
                        monthSequence.push(monthNames[(currentMonth + i) % 12]);
                    }
                    console.log(monthSequence); // Log the array of 13 months to check


                    // Map saved values to the correct cells
                    for (const [key, value] of Object.entries(data)) {
                        const [savedMonth, cellId] = key.split(':').map(str => str.trim());

                        // Find the index of the saved month in the current sequence
                        const expectedColumnIndex = monthSequence.indexOf(savedMonth);

                        if (expectedColumnIndex !== -1) {
                            // Get the actual cell ID in the current table
                            const actualCellId = cellId.trim();

                            // Update the cell content if it exists
                            const cell = document.getElementById(actualCellId);
                            if (cell) {
                                cell.textContent = value;
                            }
                            console.log(`Generated actualCellId: ${actualCellId}`);

                        }
                    }
                })
                .catch(error => console.error('Error loading saved values:', error));
        });


        function saveChanges() {
            const monthHeaders = JSON.parse('{{ month_headers | tojson }}');  // Pass the month headers from the backend
            const modifiedCells = {};

            // Collect only the critical cells to save based on their IDs
            document.querySelectorAll('td[id]').forEach(cell => {
                const id = cell.id;

                // Check if the cell's ID matches one of the critical categories
                if (
                    id.startsWith('r-fin-') || // Raise FIN %
                    id.startsWith('r-ind-') || // Raise IND %
                    id.startsWith('r-ns-') ||  // Raise NS %
                    id.startsWith('sl-') ||    // Sick Leaves
                    id.startsWith('ff-') ||    // Fixed Fee
                    id.startsWith('ss-') ||    // Sanctions
                    id.startsWith('pc-') ||    // Personnel Changes
                    id.startsWith('tc-')       // Travel Costs
                ) {
                    // Extract the month index from the ID (e.g., "1" from "r-fin-1")
                    const monthIndex = parseInt(id.match(/\d+/)[0], 10); // Get the number part like "1", "2", "3"

                    // The forecast starts from month_headers[3] onward, so adjust accordingly
                    const monthName = monthHeaders[monthIndex + 2];  // Correct adjustment to match monthHeaders starting at index 3

                    // Build a dynamic key with the month name, full ID (e.g., r-fin-1), and value
                    const key = `${monthName}: ${id}`; // Key should be like "Dec: r-fin-1"
                    
                    // Store the cell's content
                    modifiedCells[key] = cell.textContent.trim();
                }
            });

            // Send the modified data to the server
            fetch('/save_changes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(modifiedCells),
            })
            .then(response => response.text())
            .then(message => alert(message)) // Show server response (message)
            .catch(error => {
                console.error('Error saving changes:', error);
                alert('Error occurred while saving changes.');
            });
        }










        function addRevenueRow() {
            const totalRow = document.getElementById('total-row');  // Find the total row by its ID
            const tableBody = totalRow.parentNode;  // Get the parent node (the <tbody> or the table)

            // Create a new row
            const newRow = document.createElement('tr');
            newRow.classList.add('removable-row');

            // Create cells for the new row
            const cell1 = document.createElement('td');
            cell1.textContent = '<add explanation>'
            newRow.appendChild(cell1)

            const cell2 = document.createElement('td');
            cell2.setAttribute('colspan', '3')
            cell2.setAttribute('class', 'no-border')
            cell2.innerHTML = '&nbsp;'
            newRow.appendChild(cell2)

            for (let i = 0; i < 13; i++) {
                const cell = document.createElement('td');
                cell.textContent = '0';  // Placeholder value
                newRow.appendChild(cell);
            }

            removeButtonCell = document.createElement('td')
            removeButtonCell.setAttribute('class', 'no-border')
            removeButtonCell.innerHTML = `<button class="remove-btn" onclick="removeRow(this)">Remove</button>`
            newRow.appendChild(removeButtonCell)

            // Insert the new row before the total row
            tableBody.insertBefore(newRow, totalRow);
        }

        function removeRow(button) {
            // Function to remove a row
            const row = button.closest('tr');
            row.parentNode.removeChild(row);
        }

        function exportCSV(button) {
            // Function to remove a row
            alert('Forecast exported to file forecast.csv');
        }

        // Add event listeners to all selectable cells
        document.querySelectorAll('.selectable').forEach(cell => {
            cell.addEventListener('click', function() {
                const to_id = this.dataset.loc + '-' + this.dataset.fc + '-' + this.dataset.month
                const to_cell = document.getElementById(to_id)
                const from_id = this.dataset.loc + (this.dataset.fc=='m' ? '-r-' : '-m-') + this.dataset.month
                const from_cell = document.getElementById(from_id)
                to_cell.classList.replace('selectable', 'highlighted');
                from_cell.classList.replace('highlighted', 'selectable');
                calculateTTM()
            });
        });
        document.querySelectorAll('.highlighted').forEach(cell => {
            cell.addEventListener('click', function() {
 
                const to_id = this.dataset.loc + '-' + this.dataset.fc + '-' + this.dataset.month
                const to_cell = document.getElementById(to_id)
                const from_id = this.dataset.loc + (this.dataset.fc=='m' ? '-r-' : '-m-') + this.dataset.month
                const from_cell = document.getElementById(from_id)
                to_cell.classList.replace('selectable', 'highlighted');
                from_cell.classList.replace('highlighted', 'selectable');
                calculateTTM()
            });
        });

        function parseNumber(s) {
            var svalue = s.replace(/[, ]/g, '');  // Remove commas and spaces
            console.log("Parsing value:", svalue); // Log the cleaned string
            const value = parseFloat(svalue);
            
            // if (isNaN(value)) {
            //     alert('Illegal value: ' + s);
            //     return 0;
            // }
            return value;
        }

        function calculateTTM() {
            for (let i = 1; i <= 13; i++) {
                // Calculate selected forecast fields
                const fin_m_cell = document.getElementById('fin-m-' + i);
                const fin_r_cell = document.getElementById('fin-r-' + i);
                const fin = fin_m_cell.classList.contains('highlighted') ? fin_m_cell.textContent : fin_r_cell.textContent;
                const ind_m_cell = document.getElementById('ind-m-' + i);
                const ind_r_cell = document.getElementById('ind-r-' + i);
                const ind = ind_m_cell.classList.contains('highlighted') ? ind_m_cell.textContent : ind_r_cell.textContent;
                const ns_m_cell = document.getElementById('ns-m-' + i);
                const ns_r_cell = document.getElementById('ns-r-' + i);
                const ns = ns_m_cell.classList.contains('highlighted') ? ns_m_cell.textContent : ns_r_cell.textContent;

                let value_fin = Math.ceil(parseNumber(fin)); // Round up
                let value_ind = Math.ceil(parseNumber(ind)); // Round up
                let value_ns = Math.ceil(parseNumber(ns)); // Round up

                // Include adjustment terms
                const raise_fin = document.getElementById('r-fin-' + i).textContent;
                const raise_ind = document.getElementById('r-ind-' + i).textContent;
                const raise_ns = document.getElementById('r-ns-' + i).textContent;
                const sl = document.getElementById('sl-' + i).textContent;

                value_fin = Math.ceil(value_fin * (1 + parseNumber(raise_fin) / 100.0));
                value_fin = Math.ceil(value_fin * (1 - parseNumber(sl) / 100.0));
                value_ind = Math.ceil(value_ind * (1 + parseNumber(raise_ind) / 100.0));
                value_ns = Math.ceil(value_ns * (1 + parseNumber(raise_ns) / 100.0));

                // Update the sum cell
                const ttm_cell = document.getElementById('ttm-' + i);
                const value = Math.ceil(value_fin + value_ind + value_ns); // Round up final total
                ttm_cell.textContent = value;
            }
        }


        function calculateTotals() {
            calculateTTM(); // Ensure TTM is calculated first
            for (let i = 1; i <= 13; i++) {
                const ttm = document.getElementById('ttm-' + i).textContent;
                const ff = document.getElementById('ff-' + i).textContent;
                const ss = document.getElementById('ss-' + i).textContent;
                const pc = document.getElementById('pc-' + i).textContent;
                const tc = document.getElementById('tc-' + i).textContent;

                // Loop through all cells with the class 'new-rev-cell' for the current month
                let newRevTotal = 0;
                document.querySelectorAll(`.new-rev-cell[data-month="${i}"]`).forEach(cell => {
                    newRevTotal += parseNumber(cell.textContent);
                });

                const total = Math.ceil(
                    parseNumber(ttm) +
                    parseNumber(ff) +
                    parseNumber(ss) +
                    parseNumber(pc) +
                    parseNumber(tc) +
                    Math.ceil(newRevTotal) // Round up
                );

                const total_cell = document.getElementById('total-' + i);
                total_cell.textContent = total; // Update rounded total
            }
        }
      

        // Function to make the cells editable
        function makeEditable(cell) {
            const oldValue = cell.textContent.trim(); // Get the original value
            const input = document.createElement('input'); // Create an input element
            input.type = 'text'; // Set input type to text
            input.value = oldValue; // Set input value to current cell value
            input.style.width = '60px'; // Adjust width to fit the cell

            // Replace the cell content with the input
            cell.textContent = ''; // Clear the cell content
            cell.appendChild(input); // Append the input element to the cell

            // Focus on the input
            input.focus();

            // Add event listeners for losing focus or pressing 'Enter'
            input.addEventListener('blur', function() {
                saveValue(cell, input);
            });
            input.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    saveValue(cell, input);
                }
            });
        }        

        function saveValue(cell, input) {
            const newValue = input.value.trim(); // Get the new value

            // Check if the input is still a child of the cell before removing it
            try {
                if (cell.contains(input)) {
                    cell.removeChild(input); // Remove the input field only if it's still present
                }
            } catch (error) {
                // console.warn('Element already removed or could not be removed:', error);
                // There seem to be no effect on functionality - mute the warning but leave as a comment for possible debugging needs in the future
            }

            cell.textContent = newValue || '0'; // Set the cell content to the new value, default to '0' if empty

            cell.classList.add('manually-changed');
        }

        // Add event listeners to the cells in the specified rows
        document.querySelectorAll('tr td[id^="r-fin-"], tr td[id^="r-ind-"], tr td[id^="r-ns-"], tr td[id^="sl-"], tr td[id^="ttm-"], tr td[id^="ff-"], tr td[id^="ss-"], tr td[id^="pc-"], tr td[id^="tc-"]').forEach(cell => {
            cell.addEventListener('click', function() {
                makeEditable(cell); // Call the function to make the cell editable
            });
        });

        function addRevenueRow2() {
            const totalRow = document.getElementById('total-row');  // Find the total row by its ID
            const tableBody = totalRow.parentNode;  // Get the parent node (the <tbody> or the table)

            // Create a new row
            const newRow = document.createElement('tr');
            newRow.classList.add('removable-row');

            // Create cells for the new row
            const cell1 = document.createElement('td');
            cell1.textContent = '<add explanation>';
            newRow.appendChild(cell1);
            cell1.addEventListener('click', function() {
                    makeEditable(cell1);
            });            

            const cell2 = document.createElement('td');
            cell2.setAttribute('colspan', '3');
            cell2.setAttribute('class', 'no-border');
            cell2.innerHTML = '&nbsp;';
            newRow.appendChild(cell2);

            for (let i = 1; i <= 13; i++) {
                const cell = document.createElement('td');
                cell.textContent = '0';  // Placeholder value
                cell.setAttribute('class', `new-rev-cell`);  // Assign common class for reference
                cell.setAttribute('data-month', i);  // Store month as data attribute

                // Add an event listener to make the cell editable on click
                cell.addEventListener('click', function() {
                    makeEditable(cell);
                });

                newRow.appendChild(cell);
            }

            const removeButtonCell = document.createElement('td');
            removeButtonCell.setAttribute('class', 'no-border');
            removeButtonCell.innerHTML = `<button class="remove-btn" onclick="removeRow(this)">Remove</button>`;
            newRow.appendChild(removeButtonCell);

            // Insert the new row before the total row
            tableBody.insertBefore(newRow, totalRow);
        function exportToCSV() {
            // Collect all table data
            const table = document.getElementById('forecast-table'); // Assuming your table has this ID
            let csvContent = "";

            // Iterate through rows to build the CSV content
            Array.from(table.rows).forEach(row => {
                const rowData = Array.from(row.cells)
                    .map(cell => cell.textContent.trim()) // Get cell text
                    .join(','); // Join cells with commas
                csvContent += rowData + "\n"; // Add row to CSV content
            });

            // Create a blob for the CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            // Create a temporary link element for download
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'forecast_export.csv'); // File name for download
            link.style.visibility = 'hidden';
            document.body.appendChild(link);

            // Trigger the download
            link.click();
            document.body.removeChild(link); // Clean up the link element
        }

        }
    </script>

</body>
</html>
{% endblock %}